import Head from 'next/head'
import styles from '../styles/register.module.css'
import React from 'react'
import { toast } from 'react-toastify'
import 'react-toastify/dist/ReactToastify.css'
import { getGeolocation } from './setup/geolocation.js'

const notify = (txt) => toast(txt)
const sleep = ms => new Promise(r => setTimeout(r, ms))

export default function Register() {

  async function registerUser(event) {
    const geolocation = await getGeolocation()
    event.preventDefault()
    const { email, firstname, lastname, password } = event.target
    var formdata = new FormData()
    formdata.append('email',      email.value)
    formdata.append('first_name', firstname.value)
    formdata.append('password',   password.value)
    formdata.append('username',   username.value)
    formdata.append('last_name',  lastname.value)
    formdata.append('custom_localisation', 0)
    formdata.append('lat',   geolocation.latitude)
    formdata.append('lon',   geolocation.longitude)
    try {
      const res = await fetch(
        'http://127.0.0.1:5000/auth/register',
        {
          body: formdata,
          method: 'POST'
        },
      )
      const text = await res.text()
      console.log('result', text)
      if (res.status === 201) {
        console.log('redirect to login page')
        notify("Vous êtes inscrit ! un mail vous a été envoyé pour confirmer votre compte")
        await sleep(5000)
        window.location.href = '/'
      } else {
        notify(text)
      }
    } catch (e) {
      console.log('bad result',e)
      // throw Error(e)
    }
  }
/**
 * @type { React.CSSProperties }
 */
    const inputStyle = {
      borderRadius:'5vh', borderWidth:'0', textAlign:'center'
    }


  return (
    <div className={styles.bgPicture}>
      <div className={styles.container}>
        <Head>
          <title>Pokélove - register</title>
          <meta name="description" content="Generated by a lot of redbull" />
          <link rel="icon" href="/logo.png" />
        </Head>

        <main className={styles.main}>
          <h1 className={styles.title}>
            Créer un compte
          </h1>
          <iframe name="here" id="here" style={{display: "none"}}></iframe>
          <form
            onSubmit={registerUser}
            style={{borderColor:'white', borderWidth:'1vh'}}
            target="here"
            >
            <input id="email" name="email"
              type="text"
              // required
              placeholder='Email'
              style={inputStyle}
            />
            <br/>
            <input id="firstname" name="firstname"
              type="text"
              // required
              placeholder='Prénom'
              style={inputStyle}
            />
            <br/>
            <input id="lastname" name="lastname"
              type="text"
              // required
              placeholder='Nom de famille'
              style={inputStyle}
            />
            <br/>
            <input id="username" name="username"
              type="text"
              // required
              placeholder="Nom d'utilisateur"
              style={inputStyle}
            />
            <br/>
            <input
              id="password"
              name="password"
              // type="password"
              // required
              pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[_\-.#^¨%,;:?!@])[a-zA-Z0-9_\-.#^¨%,;:?!@].{8,}"
              placeholder='Mot de passe'
              style={inputStyle}
            />
            <br/>
            <button style={{color: 'white'}} type="submit" className={styles.card}>
              s'inscrire
            </button>

          </form>

          <a href="./login" className={styles.card}>
            <h2>Déjà inscrit ? &rarr;</h2>
            <p>Se connecter</p>
          </a>

        </main>
      </div>
    </div>
  )
}
